<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Simulador PID</title>

    <!-- PyScript moderno -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.3.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2025.3.1/core.js"></script>
  </head>
  <body>
    <div style="max-width: 700px; margin: 1rem auto; padding: 1rem; border: 1px solid #ccc;">
      <h3>Simulador PID (respuesta al escalón)</h3>

      <label for="kp">Kp:
        <input type="range" id="kp" min="0" max="10" step="0.1" value="2">
        <span id="kp_val">2.0</span>
      </label>
      <br>

      <label for="ki">Ki:
        <input type="range" id="ki" min="0" max="5" step="0.1" value="0">
        <span id="ki_val">0.0</span>
      </label>
      <br>

      <label for="kd">Kd:
        <input type="range" id="kd" min="0" max="5" step="0.1" value="0.5">
        <span id="kd_val">0.5</span>
      </label>

      <div id="plot" style="margin-top: 1rem;"></div>
    </div>

    <!-- Código Python + configuración de paquetes -->
    <script type="py" config='{"packages": ["matplotlib"]}'>
from js import document
import matplotlib.pyplot as plt
from pyscript import display

def simulate(kp, ki, kd):
    # Sistema de primer orden: x_dot = -a x + b u
    a = 1.0
    b = 1.0
    dt = 0.01
    T  = 5.0
    n  = int(T / dt)

    x = 0.0        # salida
    ref = 1.0      # escalón unitario
    integral = 0.0
    e_prev = 0.0

    ts = []
    ys = []

    for k in range(n):
        t = k * dt
        e = ref - x
        integral += e * dt
        derivative = (e - e_prev) / dt

        u = kp * e + ki * integral + kd * derivative

        # dinámica del sistema
        x += (-a * x + b * u) * dt

        e_prev = e
        ts.append(t)
        ys.append(x)

    return ts, ys

def update_labels(kp, ki, kd):
    document.getElementById("kp_val").innerText = f"{kp:.1f}"
    document.getElementById("ki_val").innerText = f"{ki:.1f}"
    document.getElementById("kd_val").innerText = f"{kd:.1f}"

def update_plot(event=None):
    kp = float(document.getElementById("kp").value)
    ki = float(document.getElementById("ki").value)
    kd = float(document.getElementById("kd").value)

    update_labels(kp, ki, kd)

    t, y = simulate(kp, ki, kd)

    fig, ax = plt.subplots()
    ax.plot(t, y, label="Salida")
    ax.axhline(1.0, linestyle="--", label="Referencia")
    ax.set_xlabel("Tiempo [s]")
    ax.set_ylabel("Salida")
    ax.set_title("Respuesta al escalón de un sistema con PID")
    ax.legend()
    ax.grid(True)

    # OJO: aquí usamos append=False, no 'clear=True'
    display(fig, target="plot", append=False)

# conectar sliders al callback
for slider_id in ["kp", "ki", "kd"]:
    document.getElementById(slider_id).addEventListener("input", update_plot)

# primera gráfica al cargar
update_plot()
    </script>
  </body>
</html>
